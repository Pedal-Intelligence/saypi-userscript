<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manual Typing Test After Dictation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .editor {
            border: 2px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            margin: 20px 0;
            min-height: 100px;
            background: white;
        }
        .lexical-editor {
            border-color: #4CAF50;
        }
        .test-button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }
        .test-button:hover {
            background: #45a049;
        }
        .test-button.simulate-dictation {
            background: #ff9800;
        }
        .test-button.simulate-dictation:hover {
            background: #e68900;
        }
        .status {
            background: #f0f0f0;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
        }
        .instructions {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 4px;
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <h1>Manual Typing Test After Dictation</h1>
    
    <div class="instructions">
        <strong>Instructions:</strong>
        <ol>
            <li><strong>Click "Simulate Dictation"</strong> to insert text using the same method our extension uses</li>
            <li><strong>Try typing manually</strong> in the editor after the simulated dictation</li>
            <li><strong>Check if normal typing works</strong> - this tests the fix for the reported issue</li>
            <li>Compare behavior with standard contenteditable below</li>
        </ol>
        <p><strong>Expected:</strong> Both manual typing and simulated dictation should work seamlessly together.</p>
    </div>

    <h2>Lexical Editor (Testing Fix)</h2>
    <div id="lexical-editor" 
         class="editor lexical-editor" 
         contenteditable="true" 
         data-lexical-editor="true">
        <p><br></p>
    </div>
    <button class="test-button simulate-dictation" onclick="simulateDictation()">Simulate Dictation</button>
    <button class="test-button" onclick="clearLexicalEditor()">Clear</button>
    <button class="test-button" onclick="focusLexicalEditor()">Focus Editor</button>

    <h2>Standard ContentEditable (Reference)</h2>
    <div id="standard-editor" 
         class="editor" 
         contenteditable="true">
    </div>
    <button class="test-button simulate-dictation" onclick="simulateStandardDictation()">Simulate Dictation</button>
    <button class="test-button" onclick="clearStandardEditor()">Clear</button>
    <button class="test-button" onclick="focusStandardEditor()">Focus Editor</button>

    <h2>Test Log</h2>
    <div class="status" id="status">
        Ready to test. Click "Simulate Dictation" then try typing manually...
    </div>

    <script>
        let testSequence = 1;
        
        function log(message) {
            const status = document.getElementById('status');
            const timestamp = new Date().toLocaleTimeString();
            status.innerHTML = `[${timestamp}] ${message}<br>` + status.innerHTML;
        }

        // Improved version of the Lexical text insertion that fixes the typing issue
        function setTextInLexicalEditor(text, target, replaceAll = false) {
            try {
                log(`Starting Lexical text insertion: "${text}"`);
                
                // Focus the element first
                if (document.activeElement !== target) {
                    target.focus();
                    log('Focused Lexical editor');
                }

                // For replacement mode, select all content first
                if (replaceAll) {
                    const selection = window.getSelection();
                    if (selection) {
                        const range = document.createRange();
                        range.selectNodeContents(target);
                        selection.removeAllRanges();
                        selection.addRange(range);
                        log('Selected all content for replacement');
                    }
                }

                // Use InputEvent with appropriate inputType - this is what modern browsers send for typing
                const beforeInputEvent = new InputEvent('beforeinput', {
                    inputType: replaceAll ? 'insertReplacementText' : 'insertText',
                    data: text,
                    bubbles: true,
                    cancelable: true,
                });

                log(`Dispatching beforeinput event with inputType: ${beforeInputEvent.inputType}`);
                const beforeInputHandled = target.dispatchEvent(beforeInputEvent);
                
                if (!beforeInputHandled) {
                    log('beforeinput was cancelled, falling back to DOM manipulation');
                    fallbackSetTextInLexicalEditor(text, target, replaceAll);
                    return;
                }

                // Follow up with input event to signal completion
                const inputEvent = new InputEvent('input', {
                    inputType: replaceAll ? 'insertReplacementText' : 'insertText',
                    data: text,
                    bubbles: true,
                    cancelable: false,
                });

                log('Dispatching input event');
                target.dispatchEvent(inputEvent);
                
                log(`‚úì Successfully inserted text via input events`);
            } catch (error) {
                log(`‚ùå Error in input event simulation: ${error.message}`);
                fallbackSetTextInLexicalEditor(text, target, replaceAll);
            }
        }

        function fallbackSetTextInLexicalEditor(text, target, replaceAll = false) {
            log('Using fallback DOM manipulation');
            if (text.trim() === '') {
                target.innerHTML = '<p><br></p>';
            } else {
                const paragraph = document.createElement('p');
                paragraph.setAttribute('dir', 'ltr');
                
                const textSpan = document.createElement('span');
                textSpan.setAttribute('data-lexical-text', 'true');
                textSpan.textContent = text;
                
                paragraph.appendChild(textSpan);
                target.innerHTML = '';
                target.appendChild(paragraph);
            }
            log('‚úì Fallback DOM manipulation completed');
        }

        function simulateDictation() {
            const editor = document.getElementById('lexical-editor');
            const testText = `Dictated text ${testSequence++}: Hello, this was inserted via simulated dictation! üé§`;
            
            log(`=== STARTING DICTATION SIMULATION ===`);
            setTextInLexicalEditor(testText, editor, true);
            log(`=== DICTATION SIMULATION COMPLETE ===`);
            log(`Now try typing manually in the Lexical editor above...`);
        }

        function simulateStandardDictation() {
            const editor = document.getElementById('standard-editor');
            const testText = `Dictated text ${testSequence++}: Hello, this was inserted via simulated dictation! üé§`;
            
            log(`=== STARTING STANDARD DICTATION SIMULATION ===`);
            editor.textContent = testText;
            editor.dispatchEvent(new Event('input', { bubbles: true }));
            log(`‚úì Standard editor text insertion completed`);
            log(`=== STANDARD DICTATION SIMULATION COMPLETE ===`);
        }

        function clearLexicalEditor() {
            const editor = document.getElementById('lexical-editor');
            log('Clearing Lexical editor...');
            setTextInLexicalEditor('', editor, true);
        }

        function clearStandardEditor() {
            const editor = document.getElementById('standard-editor');
            log('Clearing standard editor...');
            editor.textContent = '';
            editor.dispatchEvent(new Event('input', { bubbles: true }));
        }

        function focusLexicalEditor() {
            const editor = document.getElementById('lexical-editor');
            editor.focus();
            log('Focused Lexical editor - try typing now!');
        }

        function focusStandardEditor() {
            const editor = document.getElementById('standard-editor');
            editor.focus();
            log('Focused standard editor - try typing now!');
        }

        // Set up event listeners to monitor typing behavior
        document.getElementById('lexical-editor').addEventListener('input', function(e) {
            if (e.isTrusted) {
                log(`‚úÖ Manual typing detected in Lexical editor: "${e.target.textContent}"`);
            } else {
                log(`ü§ñ Programmatic input in Lexical editor`);
            }
        });

        document.getElementById('standard-editor').addEventListener('input', function(e) {
            if (e.isTrusted) {
                log(`‚úÖ Manual typing detected in standard editor: "${e.target.textContent}"`);
            } else {
                log(`ü§ñ Programmatic input in standard editor`);
            }
        });

        // Set up focus/blur logging
        document.getElementById('lexical-editor').addEventListener('focus', function() {
            log('üéØ Lexical editor focused');
        });

        document.getElementById('lexical-editor').addEventListener('blur', function() {
            log('üëã Lexical editor blurred');
        });

        log('Test page loaded and ready!');
    </script>
</body>
</html>